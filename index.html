<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Belbo</title>
  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
  <!-- FullCalendar CSS -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.0/main.min.css" rel="stylesheet" />
  <style>
    .fc-daygrid-day:hover { box-shadow: 0 0 8px rgba(0,123,255,0.7); cursor: pointer; }
  </style>
  <!-- Shared.js (modular Firebase setup) -->
  <script type="module" src="Shared.js"></script>
</head>
<body>
  <!-- Navbar -->
  <nav id="nav-main" class="navbar navbar-dark bg-dark fixed-top">
    <a class="navbar-brand" href="index.html">Belbo</a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav ml-auto">
        <li class="nav-item"><a class="nav-link" href="index.html">Home</a></li>
        <li class="nav-item"><a class="nav-link" href="profile.html">Profile</a></li>
        <li class="nav-item disabled"><a class="nav-link">Disabled</a></li>
        <li class="nav-item"><a id="logoutBtn" class="nav-link" href="#">Logout</a></li>
      </ul>
    </div>
  </nav>

  <!-- Calendar Container -->
  <div class="container" style="padding-top:80px">
    <div id="calendar"></div>
  </div>

  <!-- Entry Modal -->
  <div class="modal fade" id="entryModal" tabindex="-1" aria-labelledby="entryModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="entryModalLabel">Add Meal Entry</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <form id="entry-form">
            <div class="form-group">
              <label>Date</label>
              <input type="text" id="entry-date" class="form-control" readonly />
            </div>
            <div class="form-group">
              <label>Meal Name</label>
              <input type="text" id="entry-food" class="form-control" placeholder="Search or enter meal name..." required />
              <div id="search-results" class="list-group mt-1"></div>
            </div>
            <div class="form-group">
              <label>Ingredients</label>
              <button type="button" id="add-ingredient-btn" class="btn btn-sm btn-outline-primary ml-2">+ Add Ingredient</button>
              <div id="ingredients-container" class="mt-2"></div>
            </div>
            <div class="form-group">
              <label>Time</label>
              <input type="time" id="entry-time" class="form-control" required />
            </div>
            <button type="submit" class="btn btn-primary">Add Entry</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Date Events Modal -->
  <div class="modal fade" id="dateModal" tabindex="-1" aria-labelledby="dateModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="dateModalLabel">Meals on <span id="dateModalDate"></span></h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <ul id="date-events-list" class="list-group"></ul>
        </div>
        <div class="modal-footer">
          <button id="date-add-btn" type="button" class="btn btn-primary">Add Meal</button>
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.0/main.min.js"></script>
  <script type="module">
    import { auth, db } from './Shared.js';
    import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js';
    import { collection, query, where, getDocs, addDoc, serverTimestamp, Timestamp, deleteDoc, doc } from 'https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js';

    document.addEventListener('DOMContentLoaded', () => {
      onAuthStateChanged(auth, async user => {
        if (!user) return;

        // fetch manifest
        let foodItems = [];
        fetch('Favorites/manifest.json')
          .then(r => r.json())
          .then(j => foodItems = j)
          .catch(e => console.error('Failed to load food manifest', e));

        const calendarEl = document.getElementById('calendar');
        // Set up calendar with dateClick showing meal list modal
        let currentDate = '';
        const calendar = new FullCalendar.Calendar(calendarEl, {
          initialView: 'dayGridMonth',
          eventContent: arg => {
            const icon = arg.event.extendedProps.icon;
            return { html: icon ? `<img src="/${icon}" style="width:16px;height:16px;vertical-align:middle;margin-right:4px">${arg.event.title}` : arg.event.title };
          },
          dateClick: info => {
            currentDate = info.dateStr;
            document.getElementById('dateModalDate').textContent = currentDate;
            const listEl = document.getElementById('date-events-list');
            listEl.innerHTML = '';
            calendar.getEvents()
              .filter(ev => ev.startStr.split('T')[0] === currentDate)
              .forEach(ev => {
                const li = document.createElement('li');
                li.className = 'list-group-item d-flex justify-content-between align-items-center';
                li.textContent = ev.title;
                const btn = document.createElement('button');
                btn.className = 'btn btn-sm btn-danger';
                btn.textContent = 'Delete';
                btn.onclick = async () => {
                  await deleteDoc(doc(db, 'calories', ev.extendedProps.docId));
                  ev.remove();
                  li.remove();
                };
                li.appendChild(btn);
                listEl.appendChild(li);
              });
            $('#dateModal').modal('show');
          }
        });

        // load existing entries
        const qSnap = await getDocs(query(collection(db, 'calories'), where('uid','==',user.uid)));
        qSnap.forEach(docSnap => {
          const d = docSnap.data();
          const start = d.dateTime ? (d.dateTime.toDate ? d.dateTime.toDate() : d.dateTime) : (d.createdAt ? d.createdAt.toDate() : null);
          if (start) calendar.addEvent({
            title: `${d.mealName} (${d.calories} kcal)`,
            start,
            extendedProps: { icon: d.icon||'', docId: docSnap.id }
          });
        });

        calendar.render();
        // Hook the Add Meal button in dateModal to entryModal
        document.getElementById('date-add-btn').onclick = () => {
          $('#dateModal').modal('hide');
          document.getElementById('entry-date').value = currentDate;
          $('#entryModal').modal('show');
        };

        // search logic
        const searchInput = document.getElementById('entry-food');
        const results = document.getElementById('search-results');
        let selectedIcon = '';
        searchInput.addEventListener('input', () => {
          const term = searchInput.value.toLowerCase().trim(); results.innerHTML = '';
          if (!term) return;
          foodItems.filter(i=>i.name.includes(term)).forEach(item=>{
            const btn = document.createElement('button'); btn.type='button'; btn.className='list-group-item list-group-item-action';
            btn.innerHTML = `<img src="/${item.icon}" width="24" style="margin-right:8px">${item.name}`;
            btn.onclick = ()=>{ document.getElementById('entry-food').value=item.name; selectedIcon=item.icon; results.innerHTML=''; };
            results.appendChild(btn);
          });
        });

        // handle submit
        document.getElementById('entry-form').addEventListener('submit', async e => {
          e.preventDefault();
          const date = document.getElementById('entry-date').value;
          const time = document.getElementById('entry-time').value;
          const dt = new Date(`${date}T${time}`);
          const mealName = document.getElementById('entry-food').value.trim();
          // gather ingredients details
          const rows = document.querySelectorAll('.ingredient-row');
          const ingredients = [];
          let totalCalories = 0;
          rows.forEach(row => {
            const name = row.querySelector('.ingredient-name').value.trim();
            const calPer = parseFloat(row.querySelector('.ingredient-calories').value);
            const qty = parseFloat(row.querySelector('.ingredient-qty').value);
            if (name && !isNaN(calPer) && !isNaN(qty)) {
              ingredients.push({ name, caloriesPerUnit: calPer, quantity: qty });
              totalCalories += calPer * qty;
            }
          });
          if (!mealName || ingredients.length === 0) return;
          await addDoc(collection(db,'calories'),{uid:user.uid,mealName,ingredients,calories: totalCalories,createdAt:serverTimestamp(),dateTime:Timestamp.fromDate(dt),icon:selectedIcon});
          calendar.addEvent({title:`${mealName} (${Math.round(totalCalories)} kcal)`,start:dt,extendedProps:{icon:selectedIcon}});
          $('#entryModal').modal('hide'); e.target.reset();
        });

        // add ingredient button handler
        document.getElementById('add-ingredient-btn').addEventListener('click', () => {
          const container = document.getElementById('ingredients-container');
          const row = document.createElement('div');
          row.className = 'ingredient-row mb-2';
          row.innerHTML = `
            <input type="text" class="form-control ingredient-name" placeholder="Search ingredient..." required />
            <ul class="list-group suggestions"></ul>
            <input type="number" class="form-control ingredient-calories" placeholder="Calories per unit" required />
            <div class="input-group mt-1">
              <input type="range" min="1" max="10" value="1" class="ingredient-qty form-control-range" />
              <span class="qty-display ml-2">1</span>
              <button class="btn btn-outline-danger remove-ingredient-btn ml-2" type="button">&times;</button>
            </div>
          `;
          container.appendChild(row);
          // remove row
          row.querySelector('.remove-ingredient-btn').addEventListener('click', () => row.remove());
          // qty slider display
          const qtyInput = row.querySelector('.ingredient-qty');
          const display = row.querySelector('.qty-display');
          qtyInput.addEventListener('input', () => display.textContent = qtyInput.value);
          // ingredient search in this row
          const nameInput = row.querySelector('.ingredient-name');
          const suggestEl = row.querySelector('.suggestions');
          nameInput.addEventListener('input', () => {
            const term = nameInput.value.toLowerCase().trim();
            suggestEl.innerHTML = '';
            if (!term) return;
            foodItems.filter(item => item.name.includes(term)).slice(0,5).forEach(item => {
              const li = document.createElement('li');
              li.className = 'list-group-item';
              li.textContent = item.name;
              li.addEventListener('click', () => { nameInput.value = item.name; suggestEl.innerHTML = ''; });
              suggestEl.appendChild(li);
            });
          });
        });
      });

      // logout handler
      const logoutBtn = document.getElementById('logoutBtn');
      if (logoutBtn) logoutBtn.addEventListener('click', async e=>{e.preventDefault();await auth.signOut();window.location.href='login.html';});
    });
  </script>
  <script>
    // navbar hover toggle
    $(function(){$('#nav-main').hover(()=>$('#navbarNav').collapse('show'),()=>$('#navbarNav').collapse('hide'));});
  </script>
</body>
</html>